<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover"/><title>Kids Bank – Lite</title><style>:root{--bg:#0e1116;--p:#151a22;--p2:#1a2130;--ink:#ebf2ff;--m:#a6b0c2;--b:#6ee7ff;--b2:#7cfead}*{box-sizing:border-box}body{margin:0;background:#0e1116;color:var(--ink);font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial}a{color:var(--b2)}.wrap{max-width:860px;margin:0 auto;padding:12px 12px calc(84px + env(safe-area-inset-bottom))}.top{position:sticky;top:0;z-index:10;background:linear-gradient(180deg,rgba(10,14,22,.92),rgba(10,14,22,.5));border-bottom:1px solid rgba(255,255,255,.06);margin:-12px -12px 10px;padding:10px 12px}.row{display:flex;align-items:center;justify-content:space-between;gap:8px;flex-wrap:wrap}.cards{display:grid;grid-template-columns:1fr 1fr;gap:10px}@media(max-width:760px){.cards{grid-template-columns:1fr}}.card{background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px}.muted{color:var(--m);font-size:12px}.pill{padding:4px 8px;border:1px solid rgba(255,255,255,.14);border-radius:999px;font-size:12px;background:rgba(255,255,255,.06)}h1{font-size:18px;margin:0}.big{font-weight:800;font-size:24px}.tabs{position:sticky;bottom:10px;display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}@media(max-width:760px){.tabs{grid-template-columns:repeat(3,1fr)}}.tab{padding:10px 8px;text-align:center;border:1px solid rgba(255,255,255,.08);border-radius:12px;background:var(--p);cursor:pointer}.tab[aria-selected="true"]{background:var(--p2)}.input,select,button{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--ink);font-size:16px}button{cursor:pointer;font-weight:700;background:linear-gradient(135deg,var(--b),var(--b2));color:#0b1220;border:none}button.secondary{background:rgba(255,255,255,.06);color:var(--ink);border:1px solid rgba(255,255,255,.18)}.grid2{display:grid;grid-template-columns:1fr 1fr;gap:8px}@media(max-width:640px){.grid2{grid-template-columns:1fr}}.list{display:grid;gap:6px}.log{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px;background:rgba(255,255,255,.04)}.section{display:none}.section.active{display:block}.toast{position:fixed;top:10px;left:50%;transform:translateX(-50%);display:flex;flex-direction:column;gap:6px;z-index:30}.t{padding:8px 12px;border-radius:10px;font-weight:700}.ok{background:#7cfead;color:#08240f}.warn{background:#ffb86b;color:#3a2300}.err{background:#ff6b81;color:#30040a}</style></head><body><div class="wrap"><div class="top row"><div class="row" style="gap:10px"><div class="pill" style="background:linear-gradient(135deg,var(--b),var(--b2));color:#0b1220;font-weight:800">¥</div><div><h1>Kids Bank – Lite</h1><div class="muted">Short build. Buttons work. Data safe.</div></div></div><div class="row" style="gap:6px"><button id="exportBtn" class="secondary" style="width:auto">Export</button><label class="secondary" style="width:auto;display:inline-flex;align-items:center;gap:6px;padding:9px 12px;cursor:pointer"><input id="importFile" type="file" accept="application/json" style="display:none">Import</label></div></div><div class="cards"><div class="card"><div class="row"><div class="muted">Total Balance</div><span class="pill" id="spentThisMonth">Spent: ¥0</span></div><div class="big" id="totalBalance">¥0</div><div class="row" style="margin-top:6px"><span class="pill">Physical: <b id="physicalBalance">¥0</b></span><span class="pill">Digital: <b id="digitalBalance">¥0</b></span><span class="pill">Savings: <b id="savingsBalance">¥0</b></span></div><div class="row" style="margin-top:6px"><span class="pill">Loans O/S: <b id="loanOutstanding">¥0</b></span><span class="pill" id="netWorthPill">Net: <b id="netWorth">¥0</b></span></div></div><div class="card"><div class="row"><div class="muted">Overview</div><span class="pill" id="periodLabel">This Month</span></div><div class="row" style="margin-top:6px;gap:6px;flex-wrap:wrap"><span class="pill">Earned: <b id="earnedPeriod">¥0</b></span><span class="pill">Spent: <b id="spentPeriod">¥0</b></span><span class="pill">Transfers: <b id="xferPeriod">¥0</b></span><span class="pill">Repay: <b id="repayPeriod">¥0</b></span><span class="pill">Interest: <b id="interestPeriod">¥0</b></span></div><div class="grid2" style="margin-top:6px"><div><label class="muted">From</label><input id="fromDate" type="date" class="input"></div><div><label class="muted">To</label><input id="toDate" type="date" class="input"></div></div><button class="secondary" id="applyRange" style="margin-top:6px;width:auto">Apply</button></div></div><div class="card section active" id="add"><div class="row"><div class="muted">Add Entry</div><span class="pill">PIN for earnings</span></div><div class="grid2" style="margin-top:8px"><div><label class="muted">Type</label><select id="entryType" class="input"><option value="earn">Earning</option><option value="spend">Spending</option></select></div><div><label class="muted">Account</label><select id="entryAccount" class="input"><option value="physical">Physical</option><option value="digital">Digital</option></select></div><div><label class="muted">Amount (¥)</label><input id="entryAmount" class="input" type="number" inputmode="numeric" pattern="\d*" min="0" step="1" placeholder="100"></div><div><label class="muted">Category</label><select id="entryCategory" class="input"><option>Chore</option><option>Snacks</option><option>Games</option><option>Stationery</option><option>Transport</option><option>Other</option></select></div><div style="grid-column:1/-1"><label class="muted">Description</label><input id="entryDesc" class="input" placeholder="e.g., Folding Clothes"></div></div><div style="margin:8px 0"><div class="muted" style="margin-bottom:4px">Quick Presets</div><div id="presetRow" class="row" style="gap:6px"></div></div><div class="row" style="gap:8px"><button id="saveEntry">Save Entry</button><button id="clearActivity" class="secondary" style="width:auto">Clear Activity</button></div></div><div class="card section" id="transfer"><div class="row"><div class="muted">Transfer</div><span class="pill">PIN</span></div><div class="grid2" style="margin-top:8px"><div><label class="muted">From</label><select id="xferFrom" class="input"><option value="physical">Physical</option><option value="digital">Digital</option><option value="savings">Savings</option></select></div><div><label class="muted">To</label><select id="xferTo" class="input"><option value="digital">Digital</option><option value="physical">Physical</option><option value="savings">Savings</option></select></div><div><label class="muted">Amount (¥)</label><input id="xferAmount" class="input" type="number" inputmode="numeric" pattern="\d*" min="0" step="1" placeholder="500"></div><div><label class="muted">Reason</label><input id="xferDesc" class="input" placeholder="e.g., move to card"></div></div><button id="doTransfer">Transfer</button></div><div class="card section" id="loans"><div class="row"><div class="muted">Loans</div><span class="pill" id="loanLimits">Limits</span></div><div class="grid2" style="margin-top:8px"><div><label class="muted">Loan (¥)</label><input id="loanAmount" class="input" type="number" inputmode="numeric" pattern="\d*" min="1" step="1" placeholder="500"></div><div><label class="muted">Deposit To</label><select id="loanAcct" class="input"><option value="digital">Digital</option><option value="physical">Physical</option></select></div><div style="grid-column:1/-1"><label class="muted">Reason</label><input id="loanDesc" class="input" placeholder="e.g., game"></div><div><label class="muted">APR %</label><input id="loanAPR" class="input" type="number" inputmode="decimal" min="0" step="0.1" placeholder="0"></div><div><label class="muted">Repay (¥)</label><input id="repayAmt" class="input" type="number" inputmode="numeric" pattern="\d*" min="1" step="1" placeholder="200"></div><div><label class="muted">Repay From</label><select id="repayFrom" class="input"><option value="digital">Digital</option><option value="physical">Physical</option><option value="savings">Savings</option></select></div></div><div class="row" style="gap:8px;margin-top:6px"><button id="takeLoan">Take Loan</button><button id="repayBtn" class="secondary" style="width:auto">Repay Loan</button></div><div class="list" id="loanList" style="margin-top:8px"></div></div><div class="card section" id="savings"><div class="row"><div class="muted">Savings</div><span class="pill" id="savingsStatus">Off</span></div><div class="grid2" style="margin-top:8px"><div><label class="muted">Save % of earning</label><input id="savingsPct" class="input" type="number" inputmode="numeric" pattern="\d*" min="0" max="100" step="1" placeholder="20"></div><div style="display:flex;align-items:end"><button id="saveSavings">Save Setting</button></div></div></div><div class="card section" id="presets"><div class="row"><div class="muted">Presets</div><span class="pill" id="presetCount">0</span></div><div class="grid2" style="margin-top:8px"><input id="pLabel" class="input" placeholder="Label e.g., Washing utensils"><input id="pAmount" class="input" type="number" inputmode="numeric" pattern="\d*" min="1" step="1" placeholder="100"><select id="pType" class="input"><option value="earn">Earning</option><option value="spend">Spending</option></select><select id="pAcct" class="input"><option value="physical">Physical</option><option value="digital">Digital</option></select></div><div class="row" style="gap:8px;margin-top:6px"><button id="addPreset">Add Preset</button><button id="resetAll" class="secondary" style="width:auto">Full Reset (keep PINs)</button></div><div id="presetList" class="list" style="margin-top:8px"></div></div><div class="card section" id="settings"><div class="muted">Settings</div><div class="grid2" style="margin-top:8px"><input id="setPinOld" class="input" placeholder="Current PIN" inputmode="numeric" maxlength="4"><input id="setPin1" class="input" placeholder="New PIN" inputmode="numeric" maxlength="4"><input id="setPin2" class="input" placeholder="Confirm" inputmode="numeric" maxlength="4"><div class="row" style="gap:6px"><input id="limitMaxLoans" class="input" type="number" inputmode="numeric" pattern="\d*" min="0" step="1" placeholder="Max Loans"><input id="limitMaxAmt" class="input" type="number" inputmode="numeric" pattern="\d*" min="0" step="1" placeholder="Max per Loan (¥)"></div></div><div class="row" style="gap:8px;margin-top:6px"><button id="savePin">Change PIN</button><button id="setSavPin" class="secondary" style="width:auto">Set/Change Savings PIN</button></div></div><div class="tabs"><div class="tab" data-tab="add" aria-selected="true">Add</div><div class="tab" data-tab="transfer">Transfer</div><div class="tab" data-tab="loans">Loans</div><div class="tab" data-tab="savings">Savings</div><div class="tab" data-tab="presets">Presets</div><div class="tab" data-tab="settings">Settings</div></div></div><div class="toast" id="toast"></div><div class="modal" id="pinModal" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40"><div class="card" style="max-width:420px;width:min(92vw,420px)"><div class="row"><b>Enter PIN</b><span class="pill" id="pinReason">Protected</span></div><input id="pinInput" class="input" placeholder="4-digit PIN" inputmode="numeric" maxlength="4" style="margin-top:8px"><div class="row" style="justify-content:flex-end;gap:8px;margin-top:8px"><button id="pinCancel" class="secondary" style="width:auto">Cancel</button><button id="pinOk" style="width:auto">OK</button></div></div></div><div class="modal" id="savingsConfirm" style="position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:40"><div class="card" style="max-width:420px;width:min(92vw,420px)"><b>Apply Savings?</b><div class="muted" id="savingsConfirmText" style="margin:6px 0">Split X% into Savings?</div><div class="row" style="justify-content:flex-end;gap:8px"><button id="savingsSkip" class="secondary" style="width:auto">Skip</button><button id="savingsApply" style="width:auto">Apply</button></div></div></div><script>(()=>{const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s);const STORE_KEY='kidsbank_v4_lite',BACKUP_KEY=STORE_KEY+'_bak',VER=1,now=()=>new Date().toISOString();const defaults={balances:{physical:0,digital:0,savings:0},transactions:[],presets:[{label:'Washing utensils',amount:100,type:'earn',acct:'physical'},{label:'Folding Clothes',amount:100,type:'earn',acct:'physical'}],pinHash:null,savingsPinHash:null,firstRun:false,loans:[],limits:{maxLoans:2,maxPerLoan:2000},savings:{pct:0},createdAt:now()};const safeParse=j=>{try{return JSON.parse(j)}catch(e){return null}};function migrate(d){d=d||{};return{...defaults,...d,balances:{...defaults.balances,...(d.balances||{})},transactions:Array.isArray(d.transactions)?d.transactions:[],presets:Array.isArray(d.presets)&&d.presets.length?d.presets:defaults.presets,loans:(d.loans||[]).map(L=>({...L,lastAccrued:L.lastAccrued||L.date,apr:L.apr||0})),firstRun:false}}function load(){let raw=localStorage.getItem(STORE_KEY);if(raw){const p=safeParse(raw);if(p)return migrate(p);const bak=safeParse(localStorage.getItem(BACKUP_KEY));if(bak)return migrate(bak)}const legacy=safeParse(localStorage.getItem('kidsbank_v3_savings_loans'));if(legacy){const m=migrate(legacy);localStorage.setItem(BACKUP_KEY,JSON.stringify(m));return m}localStorage.setItem(STORE_KEY,JSON.stringify(defaults));localStorage.setItem(BACKUP_KEY,JSON.stringify(defaults));return {...defaults}}const state=load();let saveTick=0;function save(){const payload=JSON.stringify({...state,__v:VER});localStorage.setItem(STORE_KEY,payload);saveTick=(saveTick+1)%5;if(!saveTick)localStorage.setItem(BACKUP_KEY,payload)}function notify(msg,type='ok',ms=1600){const box=$('#toast');const el=document.createElement('div');el.className=`t ${type}`;el.textContent=msg;box.appendChild(el);setTimeout(()=>el.remove(),ms)}const hasher=async t=>{if(window.crypto&&crypto.subtle){const enc=new TextEncoder().encode('kidsbank:'+t);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('')}return btoa('kidsbank:'+t)};async function setPin(p){state.pinHash=await hasher(p);save()}async function verifyPin(p){if(!state.pinHash)return false;return (await hasher(p))===state.pinHash}async function setSavPin(p){state.savingsPinHash=await hasher('sav:'+p);save()}async function verifySavPin(p){if(!state.savingsPinHash)return false;return (await hasher('sav:'+p))===state.savingsPinHash}function promptPIN(mode='parent',reason){return new Promise(res=>{$('#pinReason').textContent=reason||'Protected';$('#pinInput').value='';const m=$('#pinModal');m.style.display='flex';const ok=()=>{const pin=$('#pinInput').value.trim();if(pin.length!==4){notify('Enter 4 digits','warn');return}const v=mode==='savings'?verifySavPin:verifyPin;v(pin).then(pass=>{if(!pass){notify('Wrong PIN','err');return}m.style.display='none';res(true)})};$('#pinOk').onclick=ok;$('#pinCancel').onclick=()=>{m.style.display='none';res(false)};$('#pinInput').onkeydown=e=>{if(e.key==='Enter')ok()};$('#pinInput').focus()})}function confirmSavings(pct,amt){return new Promise(r=>{const m=$('#savingsConfirm');$('#savingsConfirmText').textContent=`Apply ${pct}% (${yen(amt)}) to Savings?`;m.style.display='flex';$('#savingsApply').onclick=()=>{m.style.display='none';r(true)};$('#savingsSkip').onclick=()=>{m.style.display='none';r(false)}})}const yen=n=>'¥'+(Math.round(n)||0).toLocaleString('ja-JP');const loanOutstanding=()=>state.loans.reduce((a,b)=>a+b.remaining,0);function accrueInterest(){const today=new Date();state.loans.forEach(L=>{if(!L.apr||L.apr<=0)return;const last=new Date(L.lastAccrued||L.date);const days=Math.floor((today-last)/86400000);if(days>0&&L.remaining>0){const add=L.remaining*(L.apr/100)*(days/365);L.remaining=Math.round(L.remaining+add);L.lastAccrued=today.toISOString();state.transactions.unshift({id:crypto.randomUUID(),type:'interest',amount:Math.round(add),description:'Interest',category:'Loan',date:now()})}})}function addLoan(amount,acct,desc,apr){accrueInterest();const loan={id:crypto.randomUUID(),amount,remaining:amount,date:now(),desc:desc||'Loan',apr:apr||0,lastAccrued:now()};state.loans.push(loan);state.balances[acct]+=amount;state.transactions.unshift({id:crypto.randomUUID(),type:'loan',amount,to:acct,description:loan.desc,category:'Loan',date:loan.date});save();render();notify(`Loan ${yen(amount)} → ${acct}`)}function repayLoan(amount){accrueInterest();let left=amount,repaid=0;for(const L of state.loans){if(L.remaining<=0)continue;const use=Math.min(left,L.remaining);L.remaining-=use;left-=use;repaid+=use;if(left<=0)break}state.loans=state.loans.filter(L=>L.remaining>0);if(repaid>0){state.transactions.unshift({id:crypto.randomUUID(),type:'repay',amount:repaid,description:'Loan repayment',category:'Loan',date:now()});notify(`Repaid ${yen(repaid)}`)}else notify('No active loans','warn');save()}function addTx(t){state.transactions.unshift(t);save();render()}async function addEarning(amount,acct,desc,cat){amount=Math.floor(Math.max(0,amount));if(!amount)return;accrueInterest();const debt=loanOutstanding();let repay=0;if(debt>0)repay=Math.min(Math.floor(amount/2),debt);const afterRepay=amount-repay;const pct=state.savings.pct||0;let toSave=0;if(pct>0){toSave=Math.floor(afterRepay*(pct/100));const ok=await confirmSavings(pct,toSave);if(!ok)toSave=0}const keep=afterRepay-toSave;if(repay>0)repayLoan(repay);state.balances[acct]+=keep;if(toSave>0){state.balances.savings+=toSave;state.transactions.unshift({id:crypto.randomUUID(),type:'save',amount:toSave,from:acct,to:'savings',description:'Savings split',category:'Savings',date:now()})}addTx({id:crypto.randomUUID(),type:'earn',amount,to:acct,description:desc||'Earning',category:cat||'Chore',date:now(),meta:{repay,saved:toSave}});notify(`Earned ${yen(amount)} → ${acct}`)}function addSpend(amount,acct,desc,cat){amount=Math.floor(Math.max(0,amount));if(!amount)return;const avail=state.balances[acct];if(amount>avail){notify(`Not enough in ${acct}. Have ${yen(avail)}`,'err');return}state.balances[acct]-=amount;addTx({id:crypto.randomUUID(),type:'spend',amount,from:acct,description:desc||'Spending',category:cat||'Other',date:now()});notify(`Spent ${yen(amount)} from ${acct}`)}function transfer(amount,from,to,desc){if(from===to)return;amount=Math.floor(Math.max(0,amount));if(!amount)return;const avail=state.balances[from];if(amount>avail){notify(`Not enough in ${from}. Have ${yen(avail)}`,'err');return}if(from==='savings'&&to==='physical'){notify('Savings → Physical not allowed','err');return}state.balances[from]-=amount;state.balances[to]+=amount;addTx({id:crypto.randomUUID(),type:'transfer',amount,from,to,description:desc||'Transfer',category:'Transfer',date:now()});notify(`Moved ${yen(amount)}: ${from} → ${to}`)}function inRange(dISO,range){if(!range)return true;const d=new Date(dISO).setHours(0,0,0,0);const a=range.from?new Date(range.from).setHours(0,0,0,0):null;const b=range.to?new Date(range.to).setHours(0,0,0,0):null;if(a&&d<a)return false;if(b&&d>b)return false;return true}function thisMonth(){const d=new Date();const from=new Date(d.getFullYear(),d.getMonth(),1).toISOString().slice(0,10);const to=new Date(d.getFullYear(),d.getMonth()+1,0).toISOString().slice(0,10);return{from,to}}function renderBalances(){$('#physicalBalance').textContent=yen(state.balances.physical);$('#digitalBalance').textContent=yen(state.balances.digital);$('#savingsBalance').textContent=yen(state.balances.savings);const total=state.balances.physical+state.balances.digital+state.balances.savings;$('#totalBalance').textContent=yen(total);const debt=loanOutstanding();$('#loanOutstanding').textContent=yen(debt);const net=total-debt;$('#netWorth').textContent=yen(net);$('#netWorthPill').style.background=net<0?'rgba(255,107,129,.12)':'rgba(124,254,173,.12)'}function renderOverview(range){const r=range||thisMonth();$('#periodLabel').textContent=r.from&&r.to?`${r.from} → ${r.to}`:'This Month';const tx=state.transactions.filter(t=>inRange(t.date,r));const earned=tx.filter(t=>t.type==='earn').reduce((a,b)=>a+b.amount,0);const spent=tx.filter(t=>t.type==='spend').reduce((a,b)=>a+b.amount,0);const xfer=tx.filter(t=>t.type==='transfer').reduce((a,b)=>a+b.amount,0);const repay=tx.filter(t=>t.type==='earn').reduce((a,b)=>a+(b.meta?.repay||0),0)+tx.filter(t=>t.type==='repay').reduce((a,b)=>a+b.amount,0);const interest=tx.filter(t=>t.type==='interest').reduce((a,b)=>a+b.amount,0);$('#earnedPeriod').textContent=yen(earned);$('#spentPeriod').textContent=yen(spent);$('#xferPeriod').textContent=yen(xfer);$('#repayPeriod').textContent=yen(repay);$('#interestPeriod').textContent=yen(interest);const tm=thisMonth();const spentM=state.transactions.filter(t=>t.type==='spend'&&inRange(t.date,tm)).reduce((a,b)=>a+b.amount,0);$('#spentThisMonth').textContent=`Spent: ${yen(spentM)}`;$('#savingsStatus').textContent=state.savings.pct>0?`On • ${state.savings.pct}%`:'Off'}function renderLoans(){const list=$('#loanList');list.innerHTML='';if(state.loans.length===0)list.innerHTML='<div class="muted">No active loans.</div>';else state.loans.forEach(L=>{const el=document.createElement('div');el.className='log';el.innerHTML=`<div><b>${L.desc||'Loan'}</b><div class="muted" style="font-size:12px">${new Date(L.date).toLocaleString()} ${L.apr?`• ${L.apr}% APR`:''}</div></div><div>Rem: <b>${yen(L.remaining)}</b> / ${yen(L.amount)}</div>`;list.appendChild(el)})}function renderPresets(){const row=$('#presetRow');if(row){row.innerHTML='';state.presets.forEach(p=>{const b=document.createElement('button');b.className='secondary';b.style.width='auto';b.textContent=`${p.label} (${yen(p.amount)})`;b.onclick=()=>{($('#entryType').value=p.type),($('#entryAccount').value=p.acct),($('#entryAmount').value=p.amount),($('#entryDesc').value=p.label),($('#entryCategory').value=p.type==='earn'?'Chore':'Other'),notify('Preset loaded')};row.appendChild(b)})}const list=$('#presetList');if(list){list.innerHTML='';state.presets.forEach((p,i)=>{const it=document.createElement('div');it.className='log';it.innerHTML=`<div><b>${p.label}</b><div class="muted" style="font-size:12px">${p.type} • ${p.acct}</div></div><div>${yen(p.amount)}</div>`;const del=document.createElement('button');del.className='secondary';del.style.width='auto';del.textContent='Delete';del.onclick=()=>{state.presets.splice(i,1);save();renderPresets();notify('Preset removed')};it.appendChild(del);list.appendChild(it)});$('#presetCount').textContent=state.presets.length}}function render(range){renderBalances();renderOverview(range);renderLoans();renderPresets()}$$('.tab').forEach(t=>t.onclick=()=>{$$('.tab').forEach(x=>x.setAttribute('aria-selected','false'));t.setAttribute('aria-selected','true');$$('.section').forEach(s=>s.classList.remove('active'));document.getElementById(t.dataset.tab).classList.add('active')});document.getElementById('saveEntry').onclick=async()=>{const type=$('#entryType').value;const acct=$('#entryAccount').value;const amt=parseInt($('#entryAmount').value||'0',10);const cat=$('#entryCategory').value;const desc=$('#entryDesc').value.trim()||(type==='earn'?'Earning':'Spending');if(!amt||amt<=0)return notify('Enter amount','warn');if(type==='earn'){const ok=await promptPIN('parent','Add Earning');if(!ok)return;addEarning(amt,acct,desc,cat)}else{addSpend(amt,acct,desc,cat)}};document.getElementById('doTransfer').onclick=async()=>{const from=$('#xferFrom').value,to=$('#xferTo').value;const amt=parseInt($('#xferAmount').value||'0',10);const desc=$('#xferDesc').value.trim()||'Transfer';if(!amt||amt<=0)return notify('Enter amount','warn');let ok=false;if(from==='savings'||to==='savings'){if(!state.savingsPinHash)return notify('Set a Savings PIN in Settings first.','warn');ok=await promptPIN('savings','Savings Transfer')}else ok=await promptPIN('parent','Transfer');if(!ok)return;transfer(amt,from,to,desc)};document.getElementById('addPreset').onclick=()=>{const label=$('#pLabel').value.trim();const amount=parseInt($('#pAmount').value||'0',10);const type=$('#pType').value,acct=$('#pAcct').value;if(!label||!amount)return notify('Label + amount','warn');state.presets.push({label,amount,type,acct});save();renderPresets();$('#pLabel').value='';$('#pAmount').value='';notify('Preset added')};document.getElementById('savePin').onclick=async()=>{const oldP=$('#setPinOld').value.trim();const a=$('#setPin1').value.trim(),b=$('#setPin2').value.trim();if(a.length!==4||b.length!==4)return notify('New PIN = 4 digits','warn');if(a!==b)return notify('PINs mismatch','err');if(oldP.length!==4)return notify('Enter current PIN','warn');if(!(await verifyPin(oldP)))return notify('Current PIN incorrect','err');await setPin(a);$('#setPinOld').value=$('#setPin1').value=$('#setPin2').value='';notify('PIN changed ✅')};document.getElementById('setSavPin').onclick=async()=>{const has=!!state.savingsPinHash;const old=has?prompt('Enter current Savings PIN (4 digits)'):'';if(has){if(!old||old.length!==4)return notify('Savings PIN not changed','warn');if(!(await verifySavPin(old)))return notify('Current Savings PIN incorrect','err')}const a=prompt('New Savings PIN (4 digits)');if(!a||a.length!==4)return notify('4 digits required','err');const b=prompt('Confirm Savings PIN');if(a!==b)return notify('Mismatch','err');await setSavPin(a);notify(has?'Savings PIN changed ✅':'Savings PIN set ✅')};document.getElementById('saveSavings').onclick=async()=>{const pct=Math.max(0,Math.min(100,parseInt($('#savingsPct').value||'0',10)));const ok=await promptPIN('parent','Change Savings');if(!ok)return;state.savings.pct=pct;save();renderOverview();notify(`Savings ${pct}%`)};document.getElementById('takeLoan').onclick=async()=>{const amt=parseInt($('#loanAmount').value||'0',10);const acct=$('#loanAcct').value;const desc=$('#loanDesc').value.trim()||'Loan';const apr=parseFloat($('#loanAPR').value||'0');if(!amt||amt<=0)return notify('Enter amount','warn');if(state.loans.length>=state.limits.maxLoans)return notify('Max active loans reached','err');if(amt>state.limits.maxPerLoan)return notify('Exceeds per-loan limit','err');const ok=await promptPIN('parent','Take Loan');if(!ok)return;addLoan(amt,acct,desc,isNaN(apr)?0:apr)};document.getElementById('repayBtn').onclick=()=>{const amt=parseInt($('#repayAmt').value||'0',10);const from=$('#repayFrom').value;if(!amt||amt<=0)return notify('Enter amount','warn');const avail=state.balances[from];if(amt>avail)return notify(`Not enough in ${from}. Have ${yen(avail)}`,'err');state.balances[from]-=amt;repayLoan(amt);save();render()};document.getElementById('limitMaxLoans').onchange=()=>{const v=parseInt($('#limitMaxLoans').value||'',10);if(!isNaN(v)){state.limits.maxLoans=Math.max(0,v);save();renderLoans();notify('Max loans updated')}};document.getElementById('limitMaxAmt').onchange=()=>{const v=parseInt($('#limitMaxAmt').value||'',10);if(!isNaN(v)){state.limits.maxPerLoan=Math.max(0,v);save();renderLoans();notify('Max per-loan updated')}};document.getElementById('applyRange').onclick=()=>{render({from:$('#fromDate').value||null,to:$('#toDate').value||null})};document.getElementById('clearActivity').onclick=()=>{if(!confirm('Clear activity only?'))return;state.transactions=[];save();render();notify('Activity cleared')};document.getElementById('exportBtn').onclick=()=>{const blob=new Blob([JSON.stringify({...state},null,2)],{type:'application/json'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`kidsbank_backup_${new Date().toISOString().slice(0,10)}.json`;document.body.appendChild(a);a.click();a.remove();setTimeout(()=>URL.revokeObjectURL(url),800)};document.getElementById('importFile').onchange=e=>{const f=e.target.files&&e.target.files[0];if(!f)return;const reader=new FileReader();reader.onload=()=>{try{const obj=JSON.parse(reader.result);const merged=migrate(obj);Object.assign(state,merged);save();render();notify('Import OK ✅')}catch(err){notify('Import failed','err')}};reader.readAsText(f)};$$('.tab').forEach(t=>t.click());render()})();</script></body></html>
